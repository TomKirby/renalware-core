machine:
  pre:
    - sudo curl --output /usr/local/bin/phantomjs https://s3.amazonaws.com/circle-downloads/phantomjs-2.1.1
    - sudo apt-get install pandoc
    - export DEBIAN_FRONTEND=noninteractive && sudo apt-get remove -y --purge mysql-server mysql-community-server
    - sudo service mongod stop; sleep 3

dependencies:
  pre:
    - gem install bundler
  post:
    - bundle exec bundle-audit update && bundle exec bundle-audit check

database:
  override:
    - cp spec/dummy/config/database.circle.yml spec/dummy/database.yml
    - bundle exec rake app:db:create app:db:structure:load

checkout:
  post:
    - git submodule sync
    - git submodule update --init

test:
  override:
    - bundle exec rspec spec --format progress
    - mkdir -p $CIRCLE_TEST_REPORTS/cucumber
    - bundle exec cucumber --format progress --format json --out $CIRCLE_TEST_REPORTS/cucumber/cucumber.cucumber

  post:
    - bundle exec cucumber -p rake_web:
       environment:
         RAILS_ENV: test
         TEST_DEPTH: web
    - bundle exec codeclimate-test-reporter "$CIRCLE_ARTIFACTS/coverage/.resultset.json"
    - pushd ./spec/dummy ; bundle exec rails db:environment:set RAILS_ENV=test ; popd
    - bundle exec rake app:db:migrate:reset app:db:seed RAILS_ENV=test
