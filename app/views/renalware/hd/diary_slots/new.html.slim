/ Invoked by Foundation Reveal from an Add Patient to Diary link
/ which is marked up as using data-reveal-ajax=true and links to this action
/ - and a format of html (would otherwise default to js)
/ We render the modal content html here and foundation will display the modal itself.

.modal
  .modal__header
    h2 Add patient
    = render "renalware/shared/modal_close_link"

  .modal__body
    = render "renalware/shared/errors", model: slot

    - form_id = SecureRandom.hex(16)

    = simple_form_for(slot,
                      html: { id: form_id },
                      url: hd_diary_slots_path(slot.diary.id),
                      remote: true,
                      method: :post,
                      wrapper: :horizontal_form) do |f|

      =f.input :station_id, as: :hidden
      =f.input :diurnal_period_code_id, as: :hidden
      =f.input :day_of_week, as: :hidden

      .row
        .col-small-4
          = f.input :change_type,
                    input_html: { id: :change_type },
                    collection: slot.patient_search_options,
                    include_blank: false,
                    label: "Search"
        .col-small-8

          / We will post 3 patient_id values in hd_diary_slot[patient_id][]
          / The value selected in in change_type above will detemine which one to choose.
          #patient_select2s
            #dialysing_on_day_and_period
              =f.input :patient_id,
                       collection: slot.patients_preferring_to_dialyse_today_in_this_period,
                       label_method: ->(item){ item.to_s(:long) },
                       value_method: :id,
                       input_html: { class: "searchable_select patient-id-select2",
                                     id: "patient_id1",
                                     name: "hd_diary_slot[patient_id][]"}

            #dialysing_on_day(style="display:none")
              =f.input :patient_id,
                       collection: slot.patients_preferring_to_dialyse_today,
                       label_method: ->(item){ item.to_s(:long) },
                       value_method: :id,
                       input_html: { class: "searchable_select patient-id-select2",
                                     id: "patient_id2",
                                     name: "hd_diary_slot[patient_id][]"}
            #dialysing_at_unit(style="display:none")
              = f.input :patient_id,
                        collection: [],
                        input_html: {\
                          id: "patient-ajax-search",
                          class: "patient-id-select2",
                          name: "hd_diary_slot[patient_id][]",
                          data: { "ajax--url" => search_patients_path(format: :json) }\
                        }

      =f.submit "Add for this week only",
                  class: "button save",
                  name: "add_to_weekly_diary"
      | &nbsp;
      =f.submit "Add to this and all future weeks",
                class: "button secondary",
                  name: "add_to_master_diary"

      = blank_separator
      =link_to "Cancel",
               "#",
               "aria-label" => "Close",
               class: "reveal-modal-close"

javascript:
  $(document).ready(function() {
    $("#change_type").on("change", function() {
      change_type = $(this).val(); // e.g. "dialysing_at_unit"
      // Hide any showing patient select2's then display just the one corresponding to
      // what was selected in change_type. The value in the change_type option
      // will exist as an html id, wrapping the patient select2s
      $("#patient_select2s > div").hide();
      $("#patient_select2s > #" + change_type).show();
      $("#patient_select2s .patient-id-select2").val("").trigger('change');
    })
  });
