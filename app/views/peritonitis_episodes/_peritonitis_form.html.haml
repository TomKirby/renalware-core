.row.peritonitis-form
  .large-12.columns

    = p.hidden_field :id

    = p.hidden_field :patient_id

    .row
      .large-12.columns
        .section-underliner
          Dates:

        .large-4.columns
          = p.label :diagnosis_date
          = p.date_select(:diagnosis_date, {start_year: (120.years.ago).year, end_year: Time.now.year, order: [:day, :month, :year]}, class: "datetime")

        .large-4.columns
          = p.label :treatment_start_date
          = p.date_select(:treatment_start_date, {start_year: (120.years.ago).year, end_year: Time.now.year, order: [:day, :month, :year]}, class: "datetime")
        .large-4.columns
          = p.label :treatment_end_date
          = p.date_select(:treatment_end_date, {start_year: (120.years.ago).year, end_year: Time.now.year, order: [:day, :month, :year]}, class: "datetime")

    .row
      .large-12.columns
        .section-underliner
          Outcome:

        .large-12.columns
          = p.label :episode_type_id
          = p.collection_select :episode_type_id, EpisodeType.all, :id, :term, { :prompt => "Please select episode type" }, :class => "episode-type_select"

        .large-12.columns
          = p.check_box :catheter_removed
          = p.label :catheter_removed

      .large-12.columns
        .section-underliner
          Organisms and their sensitivities for this peritonitis episode:

        = p.fields_for :infection_organisms, @peritonitis_episode.infection_organisms do |io|

          - if io.object.new_record?

            #new-organism-form
              %a.button.tiny.toggle.right.mt{ href: '#new-organism-form' }
                Record a new organism and sensitivity

              .hide
                %a.button.tiny.close-new-form{ href: '#' }
                  Close

                %fieldset
                  %legend
                    Record a new organism and sensitivity

                  .row

                    = render :partial => 'infection_organisms/organism_fields', :locals => { :io => io }

          - else

            %dl.accordion{data: {accordion: true} }
              %dd.accordion-navigation.organism-form

                %a.fi-plus.fi-minus{ href: "#edit-organism-#{io.object.id}", class: "organism-accordian" }

                  = "#{io.object.organism_code.name}, #{io.object.sensitivity}"

                  .right.edit
                    Edit

                .columns.large-6.organism-form.content{:id => "edit-organism-#{io.object.id}", data: { index: 0 }}

                  = render :partial => 'infection_organisms/organism_fields', :locals => { :io => io }

                  .organism-form.content{:id => "edit-organism-#{io.object.id}"}
                    = io.check_box :_destroy
                    = io.label :_destroy, "Terminate?", class: "delete"

    .row
      .large-12.columns
        .section-underliner
          Causes/Symptoms:

        .large-12.columns
          = p.check_box :line_break
          = p.label :line_break

          = p.check_box :exit_site_infection
          = p.label :exit_site_infection

          = p.check_box :diarrhoea
          = p.label :diarrhoea

          = p.check_box :abdominal_pain
          = p.label :abdominal_pain

        .large-12.columns
          = p.label :fluid_description_id
          = p.collection_select :fluid_description_id, FluidDescription.all, :id, :description, { prompt: "Please select description that best describes fluid" }, :class => "episode-type_select"

    .row
      .large-12.columns
        .section-underliner
          White Cell Count:

        .large-4.columns
          = p.label :white_cell_total
          = p.text_field :white_cell_total
        .large-2.columns
          = p.label :white_cell_neutro, "Neutro (%)"
          = p.text_field :white_cell_neutro
        .large-2.columns
          = p.label :white_cell_lympho, "Lympho (%)"
          = p.text_field :white_cell_lympho
        .large-2.columns
          = p.label :white_cell_degen, "Degen (%)"
          = p.text_field :white_cell_degen
        .large-2.columns
          = p.label :white_cell_other, "Other (%)"
          = p.text_field :white_cell_other

    .row
      .large-12.columns
        .section-underliner
          Comments:

        .large-12.columns
          = p.label :notes, "Episode notes"
          = p.text_area :notes, :cols => 50, :rows => 6

    .row
      .large-12.columns
        .section-underliner
          Medications administered for this peritonitis episode:

        = p.fields_for :medications, @peritonitis_episode.medications do |pm|

          - if pm.object.new_record?

            #new-form
              %a.button.tiny.toggle.right.mt{href: '#new-form'}
                Add a new medication

              .hide
                %a.button.tiny.close-new-form{href: '#'}
                  Close

                %fieldset
                  %legend
                    Add a new medication

                  .row

                    = render :partial => 'patients/medication_fields', :locals => { :pm => pm }

          - else

            %dl.accordion{data: {accordion: true} }
              %dd.accordion-navigation.med-form

                %a.fi-plus.fi-minus{href: "#edit-meds-#{pm.object.id}", :class => "drug-#{drug_types_colour_tag(pm.object.medicatable.drug_types)}"}

                  = "#{pm.object.medicatable.name}, #{pm.object.dose}, #{pm.object.medication_route.name}, #{pm.object.frequency}, #{pm.object.date}"

                  .right.edit
                    Edit

                .columns.large-6.meds-form.content{:id => "edit-meds-#{pm.object.id}", data: { index: 0 }}

                  = render :partial => 'patients/medication_fields', :locals => { :pm => pm }

                  .med-form.content{:id => "edit-meds-#{pm.object.id}"}
                    = pm.check_box :_destroy
                    = pm.label :_destroy, "Terminate?", class: "delete"

