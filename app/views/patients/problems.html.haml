.row  
  %h5
    = link_to "Patient Problems", problems_patient_path(@patient)

.row
  = form_for @patient do |f|  
    = hidden_field_tag :redirect_url, problems_patient_path(@patient)
    
    = f.fields_for :problems do |pb|

      - if pb.object.new_record?

        #new-probs-form   
          %a.button.tiny.toggle.right.mt{href: '#new-probs-form'}
            Add a new problem

          .hide
            %a.button.tiny.close-new-form{href: '#'}
              Close

            %fieldset
              %legend
                Add New Problem

              .row#new-probs-template

                .problem-form{data: { index: @patient.problems.length - 1 }}
                  .a-problem
                                        
                    = pb.hidden_field :id
                    = pb.hidden_field :patient_id

                    = label_tag :snomed_term
                    = text_field_tag :snomed_term, nil, :placeholder => "Enter a snomed concept", :class => "snomed-lookup"

                    %ul.no-bullet.snomed-results

                    = pb.hidden_field :snomed_id, :class => "selected-snomed-id"

                    = pb.label :description
                    = pb.text_field :description, :class => "probs-description"

                    //change to hidden 
                    = pb.label :user_id
                    = pb.text_field :user_id
              
                .hidden-problem-form
                  = render :partial => 'problem_form', :locals => { :pb => pb }
              
                #additional-form

              %a.button.tiny.left.mt.add-problem{href: '#'}
                Add another problem
    
        = link_to "Cancel", clinical_summary_patient_path(@patient), class: "button tiny left cancel mt"
                   
      - else
        %dl.accordion{data: {accordion: true} }
          %dd.accordion-navigation.med-form
            %a{ class: "problem", href: "#edit-probs-#{pb.object.id}"}
              %ul.probs-list.no-bullet.med-list
                %li
                  = "#{pb.object.description},"        
                %li
                  = "#{pb.object.created_at.strftime("%d/%m/%Y")}" 
            
            .probs-form.content{:id => "edit-probs-#{pb.object.id}", data: { index: 0 }}         
              = render :partial => 'problem_form', :locals => { :pb => pb }

            .probs-form.content{:id => "edit-probs-#{pb.object.id}"}  
              = pb.check_box :_destroy
              = pb.label :_destroy, "Terminate?", class: "delete"

    = f.submit "Save Problems", :class => "button tiny right save mt"

.clinical-summary
  = content_for :secondary_nav do  
    = render partial: "patients/clin_sum_sub_nav", locals: { model: @patient }


