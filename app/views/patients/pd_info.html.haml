.main-content
  .row
    = render partial: "patients/mini_renal_profile", locals: { model: @patient }

.row  
  %h5.g-center
    = link_to "PD Info", pd_info_patient_path(@patient)

.wide-screen
  %h4
    = "Peritonitis Episode (#{@patient.peritonitis_episodes.length})"
  
  %ul.no-bullet
    = form_for @patient do |f|
      
      = hidden_field_tag :redirect_url, pd_info_patient_path(@patient)
      
      = f.fields_for :peritonitis_episodes, @peritonitis_episodes do |p|

        - if p.object.new_record?

          #new-form
            %a.button.tiny.toggle.right.mt{href: '#new-form'}
              Add a new peritonitis episode

            .hide
              %a.button.tiny.close-new-form{href: '#'}
                Close
              
              %fieldset
                %legend
                  Add a Peritonitis Episode

                .row
                  = render :partial => 'peritonitis_form', :locals => { :p => p }

                
          = link_to "Cancel", clinical_summary_patient_path(@patient), class: "button tiny left cancel mt"
          
        - else
          %table.responsive
            %thead
              %th.table-width 
                Diagnosis Date
              %th.table-width 
                Start Treatment Date
              %th.table-width 
                End Date
              %th.table-width 
                Episode Type
              %th.table-width 
                Notes
              %th.table-width 
                White Cell Count
              %th.table-width 
                Entered By

            %tbody
              %tr{ valign: "top" }
                %td{:data => { :heading => "Diagnosis Date" }}
                  = p.object.diagnosis_date.strftime("%d/%m/%Y")
                %td{:data => { :heading => "Start Date"}}
                  = p.object.start_treatment_date.strftime("%d/%m/%Y")
                %td{:data => { :heading => "End Date"}}
                  = p.object.end_treatment_date.strftime("%d/%m/%Y")
                %td{:data => { :heading => "Episode Type"}}
                  = p.object.episode_type
                %td{:data => { :heading => "Description", valign: "top" }}
                  %dl.accordion{data: {accordion: true} }
                    %dd.accordion-navigation
                      %a.fi-plus.fi-minus.toggle-notes{ :id => "patient-peritonitis-notes-#{p.object.id}", href: "#patient-peritonitis-notes-#{p.object.id}" }
                        Read Notes
                      .content.toggle-content{ :id => "patient-peritonitis-notes-#{p.object.id}" } 
                        = p.object.notes
                %td{ :data => { :heading => "White Cell Count", valign: "top"} } 
                  %dl.accordion{ data: { accordion: true } }
                    %dd.accordion-navigation
                      %a.fi-plus.fi-minus.toggle-notes{ :id => "patient-peritonitis-white-cell-#{p.object.id}", href: "#patient-peritonitis-white-cell-#{p.object.id}" }
                        = p.object.white_cell_total
                      .content.toggle-content{ :id => "patient-peritonitis-white-cell-#{p.object.id}" } 
                        = "Neutro: #{p.object.white_cell_neutro}%"
                        = "Lympho: #{p.object.white_cell_lympho}%"
                        = "Degen: #{p.object.white_cell_degen}%"
                        = "Other: #{p.object.white_cell_other}%"

              

                %td{:data => { :heading => "Entered By"}}
                  = p.object.user_id
          
          %dl.accordion{data: {accordion: true} }
            %dd.accordion-navigation.peritonitis-form
              %a.fi-plus.fi-minus{ href: "#edit-peritonitis-#{p.object.id}" }
                  
                = "Diagnosis Date: #{p.object.diagnosis_date.strftime("%d/%m/%Y")}, Start Date: #{p.object.start_treatment_date.strftime("%d/%m/%Y")}, End Date: #{p.object.end_treatment_date.strftime("%d/%m/%Y")}, Episode Type: #{p.object.episode_type}, White Cell Count: #{p.object.white_cell_total}"
                .right.edit
                  Edit

              .columns.large-6.peritonitis-form.content{:id => "edit-peritonitis-#{p.object.id}", data: { index: 0 }}
                 
                = render :partial => 'peritonitis_form', :locals => { :p => p } 

                / .peritonitis-form.content{:id => "edit-meds-#{p.object.id}"}  
                /   = p.check_box :_destroy
                /   = p.label :_destroy, "Terminate?", class: "delete"


      = f.submit "Save Peritonitis Episode", :class => "button tiny right save mt"

.wide-screen
  = content_for :secondary_nav do  
    = render partial: "patients/clin_sum_sub_nav", locals: { model: @patient }

